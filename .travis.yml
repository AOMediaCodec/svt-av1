language: c
dist: xenial

addons:
  apt:
    packages:
     - cmake
     - yasm
  homebrew:
    packages:
      - yasm

jobs:
  include:
   # General Linux build job
   - name: Build
     before_install:
     - apt-get update && apt-get install -y libaom
     - wget -nc https://mf4.xiph.org/~ltrudeau/videos/nyan.y4m
     script:
     - cd Build/linux
     - ./build.sh release
     - valgrind --leak-check=full ../../Bin/Release/SvtAv1EncApp -i nyan.y4m -enc-mode 0 -lp 1 -q 24 -o out.yuv -b out.ivf
     - aomdec out.ivf -o /dev/null

   # General Linux debug build job
   - name: Debug build
     script:
     - cd Build/linux
     - ./build.sh debug
   # General macOS build job
   - name: macOS build
     os: osx
     script:
     - cd Build/linux
     - ./build.sh release     
   # Coveralls test job
   - name: Coveralls
     before_install:
     - pip install --user cpp-coveralls
     script:
     - cd Build/linux
     - ./build.sh release
     after_success:
     - coveralls
     
   # FFmpeg interation build
   - name: FFmpeg patch
     script:
     # Build and install SVT-AV1
     - cd $TRAVIS_BUILD_DIR
     - cd Build
     - cmake ..
     - make -j$(nproc)
     - sudo make install
     # Apply SVT-AV1 plugin and enable libsvtav1 to FFmpeg
     - git clone https://github.com/FFmpeg/FFmpeg ffmpeg
     - cd ffmpeg
     - git checkout release/4.1
     - git apply $TRAVIS_BUILD_DIR/ffmpeg_plugin/0001-Add-ability-for-ffmpeg-to-run-svt-av1.patch
     - export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/usr/local/lib
     - export PKG_CONFIG_PATH=${PKG_CONFIG_PATH}:/usr/local/lib/pkgconfig
     - ./configure --enable-libsvtav1
     - make --quiet -j$(nproc)
